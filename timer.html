<html>
<head>
<title>Timer</title>
</head>
<body>

<div id="timer">
    <div class="minuti">
        <div contenteditable onchange="controllaNumero()"></div>
        <p>minuti</p>
    </div>
    <div class="secondi">
        <div contenteditable onDOMCharacterDataModified="controllaNumero()"></div>
        <p>secondi</p>
    </div>
	<input id="avvio" type="button" value="avvio" disabled="true" onclick="conta()" />
	<input id="reset" type="button" value="reset" disabled="true" onclick="reset()" />
</div>




<script>

let msg = new SpeechSynthesisUtterance();
let voices = window.speechSynthesis.getVoices();
msg.voice = voices[10]; // Note: some voices don't support altering params
msg.voiceURI = 'native';
msg.volume = 1; // 0 to 1
msg.rate = 1; // 0.1 to 10
msg.pitch = 2; //0 to 2
msg.lang = 'it-IT';

getDivMinuti().addEventListener('input', controllaNumero, false);
getDivSecondi().addEventListener('input', controllaNumero, false);

function controllaNumero() {
	let minuti = getDivMinuti().innerHTML;
	let secondi = getDivSecondi().innerHTML;
	let sonoNumeri = isNumeric(minuti) && isNumeric(secondi);
	getAvvio().disabled = !sonoNumeri;
}

function isNumeric(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

function parla(text) {
	msg.text = text;
	speechSynthesis.speak(msg);
}

let nextStop = 0;
let intervalloMaggiore = 30000;
let intervalloMinore = 15000;
let soglia = 60000;


function getTimer() {
	return document.getElementById( 'timer' );	
}
function getDivMinuti() {
	return getTimer().querySelector( '.minuti div' );
}

function getDivSecondi() {
	return getTimer().querySelector( '.secondi div' );
}

function getMinuti() {
	return getDivMinuti().innerHTML;
}

function getSecondi() {
	return getDivSecondi().innerHTML;
}

function setMinuti(value) {
	getDivMinuti().innerHTML = ('0' + value).slice(-2);
}

function setSecondi(value) {
	getDivSecondi().innerHTML = ('0' + value).slice(-2);
}

function getAvvio() {
	return getTimer().querySelector( '#avvio' );
}

function getReset() {
	return getTimer().querySelector( '#reset' );
}

let inCorso = false;
function conta() {
	inCorso = !inCorso;
	if (inCorso) {
		avvio();
	}
	else {
		pausa();
	}
	
	getReset().disabled = false;
}

function reset() {
	inCorso = false;
	pausa();
	getReset().disabled = true;
	primoAvvio = true;
	setMinuti( minutiIniziali );
	setSecondi( secondiIniziali );
}

function pausa() {
	getAvvio().value = "avvio";
	clearInterval(intervalloTempo);
}

let primoAvvio = true;
let minutiIniziali;
let secondiIniziali;

function avvio() {
	let minuti = parseInt(getDivMinuti().innerHTML);
    let secondi = parseInt(getDivSecondi().innerHTML);
	if (primoAvvio) {
		minutiIniziali = minuti;
		secondiIniziali = secondi;
	}
	primoAvvio = false;
	getAvvio().value = "pausa";
	let durata = (minuti * 60 + secondi) * 1000;
	console.log(durata);
	if (durata > soglia) {
		nextStop = durata - durata % soglia;
	} else {
		nextStop = durata - durata % intervalloMinore;
	}

	let scadenza = new Date(Date.parse(new Date()) + durata);
	inizializzoTimer( scadenza );
}

function tempoRimasto(tempo){
  let t = Date.parse(tempo) - Date.parse(new Date());
  let sec = Math.floor( (t/1000) % 60 );
  let min = Math.floor( (t/1000/60) % 60 );
  return {
    'totale': t,
    'minuti': min,
    'secondi': sec
  };
}

let intervalloTempo;

function inizializzoTimer(scadenza){

    function aggiornaTimer(){
        let t = tempoRimasto(scadenza);   
      
		setMinuti(t.minuti);
		setSecondi(t.secondi);
      
		if(t.totale <= nextStop) {
			var msg = "";
			if (t.minuti > 1) {
				msg = t.minuti + " minuti ";
			}
			else if (t.minuti == 1) {
				msg = t.minuti + " minuto ";
			}
			
			if (t.secondi > 0) {
				msg += t.secondi + " secondi";
			}	
			nextStop -= nextStop > soglia ? intervalloMaggiore : intervalloMinore;
			console.log(nextStop);
			
			if (nextStop < 0) {
				nextStop = 0;
			}
			parla(msg);
		}

        if(t.totale<=0){
            clearInterval(intervalloTempo);
			parla("tempo finito");
        }
	}

    aggiornaTimer();

    intervalloTempo = setInterval(aggiornaTimer,1000);
}

</script>

<style>
body{
  /*background-color: #C8E6C9;*/
  font-family: "Calibri Light";
}

#timer{
  display: flex;
  justify-content: center;
  margin-top: 50px;
  font-size: 26px;
}

#timer div{
  margin: 5px 5px;
  text-align: center;
}

#timer div div{
  background-color: black;
  border-radius: 6px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  padding: 10px;
  width: 50px;
}

#timer div p{
  font-weight: bold;
}

#timer input{
  font-size: 40px;
  font-weight: bold;
  font-family: "Calibri Light";
  height: 60px;
  margin: 15px;
}
</style>
</body>
</html>